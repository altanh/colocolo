% Thomas Bernardi
% University of Washington
% HLIN501 Study Guide
% November 2017

\documentclass{article}
\usepackage[T1]{fontenc}
% \usepackage{babel}
\usepackage[margin=1in]{geometry}
\usepackage{parskip}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{tabularx}
\usepackage{graphicx}
\usepackage{enumitem}
\graphicspath{ {./graphs/} }
\usepackage[noend]{algorithmic}
\usepackage{amsmath, amsfonts, amsthm, amssymb} 
\usepackage{listings}

\theoremstyle{definition}
\newtheorem{definition}{Definition}[subsection]
\newtheorem{theorem}{Theorem}[section]
\title{Let's sk*lemize some f\%rmula\$!}
\date{February 2019}
\author{Thomas Bernardi, Altan Haan}

\DeclareMathOperator{\bigdot}{\bullet}

\begin{document}
	\maketitle
	\begin{center}	
		\textit{Everything is a lie, nothing is real.} \\
    \end{center}

    \section{What is Skolemization?}

    Skolemization is a process whomst'd've allows us to remove (semantically) existential quantifiers, and replace existentially quantified variables with functions, or relations in the case of alloy. Skolemization relies on a key second order equivalence:

    $$\forall x \exists y~.~P(x, y) \Leftrightarrow \exists f \forall x~.~P(x, f(x))$$

    where $f(x)$ is a function (relation) that maps $x$ to $y$. Intuitively we are translating between ``forall $x$ there exists a $y$ such that $P(x, y)$'' into ``there exists a function $f : x \rightarrow y$ such that, forall $x$, $P(x, f(x))$.'' This is useful because the existence of $f$ is semantically equivalent to the satisfiability of the formula if $f$ was free, so we can drop the exists and reason about the satisfiability of the formula.

    Neat.

    \section{How does skolemize?}

    Skolemization in alloy/kodkod is a tricky beast. Note when we say ``existential quantifiers'' we are talking about this in the semantic sense: ``$\exists$'' and ``$\neg\forall$''---the same holds for ``universal quantifiers'': ``$\forall$'' and ``$\neg \exists$.''

    At it's core skolemization is very simple: as we descend the AST, we keep track of in-scope variables $S_\forall$ that are universally quantified. When we hit an existentially quantified variable $v$, we create a function $f$ from the variables in $S_\forall$ to $v$, replace every occurrence of $v$ with $f$ in every subformula, and return the expression with the quantifier removed. Unfortunately it is not quite this simple...

    \subsection{Some vocabularies:}

    \theoremstyle{definition}
    \begin{definition}{Declaration}
        A declaration allows us to define variables in terms of other expressions (and all declarations can eventually be traced back to relations in the universe). A declaration contains a \textbf{variable}, a \textbf{multiplicity}, and an \textbf{expression}.

        \begin{center}
            \begin{tabular}{c c c c}
                $x$ & : & some & $E$ \\
                variable & & multiplicity & expression
            \end{tabular}
        \end{center}
    \end{definition}

    \subsection{The gritty nitty details}

    An existential quantifier will bring one or more variables into scope with one or more \textbf{declarations}. For each of these \textbf{declarations} $d := v~:~m~R$, we must do the following:

    Assume $S_\forall$ is a list of all universally quantified variables that are currently in scope.

    \begin{itemize}
        \item Define the \textbf{skolem relation}, $\textsf{R}_v$ of arity $\text{size}(S_\forall) + \text{arity}(v)$ (every element of $S_\forall$ should be unary).
        \item Define our \textbf{skolem expression} $\textsf{E}_v$ which will replace every occurrence of $v$ further down the AST.
        \item Approximate an \textbf{upper bound} for the \textbf{skolem relation}.
        \item Calculate \textbf{domain constraints} that ensure the ``inputs'' to $\textsf{R}_v$ are constrained in the same way that their corresponding universally quantified variables are---store these, these will be conjuncted with the formula on the way up the AST once there are no more existential quantifiers. Specifically, these constraints encode multiplicity information that relational bounds cannot infer.
        \item Add \textbf{range constraints} to the formula to ensure that the ``outputs'' of $S$ are constrained in the same way as $v$. Multiplicity information?
    \end{itemize}

    \subsubsection*{Skolem Expression}

    The \textbf{skolem expression}, $\textsf{E}_v$, is what actually replaces $v$. It is the result of joining each non-skolem $a_i \in S_\forall$ with the $\textsf{R}_v$, or $\textsf{E}_v := f~S_\forall~\textsf{R}_v$ where $f$ is defined as follows:
    
    \begin{align*}
        f~[]~X& = X\\
        f~a_i::L~X& = f~L~a_i.X
    \end{align*}

    \subsubsection*{Upper Bound}
    Some FOL2BOOL magic.

    \subsubsection*{Domain Constraints}

    Suppose $R$ is of arity $n$. We call $\textsf{U}$ the universe. Let $I_v = \textsf{R}_v.\textsf{U} \dots \textsf{U}$ where $\textsf{U}$ is joined to $\textsf{R}_v$ $n$ times. Let the $i$th declaration $a_i~:~m_i~R_i$ be the declaration that binds the $i$th variable, $a_i \in S_\forall$. Let $k = \text{length}(S_\forall)$. Our domain constraint is:
    $$I_v ~ \texttt{in} ~ \{a_0~:~m_0~R_0, \dots, a_k~:~m_k~R_k~\vert~\top\}.$$

    Note the expression $\{a_0~:~m_0~R_0, \dots, a_k~:~m_k~R_k~\vert~\top\}$ defines a $k$-ary relation where the $i$th element obeys the $i$th \textbf{declaration} with no other constraints (any relation satisfies $\top$).

    The domain constraints for each subformula in the skolemized formula are lastly conjuncted together at the top level to form the final domain constraint for the whole formula.



    \subsubsection*{Range Constraints}
    Our range constraint is simply $\textsf{E}_v ~\texttt{in}~ m~R$. Let $f' := \textsf{skolemize}(f[\textsf{E}_v / v])$ in $Qv~:~m~R \mid f$ where $Q \in \{\exists, \neg \forall\}$. When our quantifier is $\exists$ the skolemized (sub)formula becomes $(\textsf{E}_v~\texttt{in}~ m~ R) \land f'$, otherwise when $Q$ is $\neg \forall$ we skolemize to $(\textsf{E}_v ~\texttt{in}~ m~R) \to f'$.

    \subsection{An example}
    Let $A$ and $B$ be relations of arity $n$ and $m$ respectively, and let $P$ be a predicate on $A\times B$. Suppose we wish to skolemize the formula
    \[\forall x : \texttt{some}\: A. \: \exists y : \texttt{some}\: B \mid P(x,y).\]
    We first traverse through the universal quantification of $x$, adding $x : \texttt{some}\: A$ to $S_\forall$ and continuing. Next we reach the existentially quantified $y$. Following the above procedure, we define $\textsf{R}_y :_{m + 1} [\{\langle \rangle\}, A\times B]$. We can then define the domain constraint
    \[\textsf{D}_y := \textsf{R}_y .\bigdot\limits_{i = 1}^m \textsf{U}~\texttt{in}~\{x : \texttt{some}\: A \mid \top\},\]
    along with the skolem expression $\textsf{E}_y := x.\textsf{R}_y$. Note that $\textsf{R}_y .\bigdot\limits_{i = 1}^m$ means left-associatively joining \textsf{U} to $\textsf{R}_y$ $m$ times. Lastly, our range constraint is $(\textsf{E}_y~\texttt{in}~\texttt{some}~B)$. As the quantifier is just an $\exists$, our skolemized subformula becomes $(\textsf{E}_y ~ \texttt{in}~\texttt{some}~B) \land P(x, \textsf{E}_y)$. Conjuncted with the top level domain constraints, we obtain the total skolemized formula
    \[\textsf{R}_y .\bigdot\limits_{i = 1}^m \textsf{U}~\texttt{in}~\{x : \texttt{some}\: A \mid \top\} \land (\textsf{E}_y ~ \texttt{in}~\texttt{some}~B) \land P(x, \textsf{E}_y).\]
    Expanding this out, we get
    \[\textsf{R}_y .\bigdot\limits_{i = 1}^m \textsf{U}~\texttt{in}~\{x : \texttt{some}\: A \mid \top\} \land (x.\textsf{R}_y ~ \texttt{in}~\texttt{some}~B) \land P(x, x.\textsf{R}_y).\]

  \end{document}
 